import e from"memoizee";import t from"axios";import*as r from"cheerio";import{parseString as i}from"xml2js";import{promisify as n}from"util";var a,s,o,A,E;!function(e){e.TOP_MAC="topmacapps",e.TOP_FREE_MAC="topfreemacapps",e.TOP_GROSSING_MAC="topgrossingmacapps",e.TOP_PAID_MAC="toppaidmacapps",e.NEW_IOS="newapplications",e.NEW_FREE_IOS="newfreeapplications",e.NEW_PAID_IOS="newpaidapplications",e.TOP_FREE_IOS="topfreeapplications",e.TOP_FREE_IPAD="topfreeipadapplications",e.TOP_GROSSING_IOS="topgrossingapplications",e.TOP_GROSSING_IPAD="topgrossingipadapplications",e.TOP_PAID_IOS="toppaidapplications",e.TOP_PAID_IPAD="toppaidipadapplications"}(a||(a={})),function(e){e[e.BOOKS=6018]="BOOKS",e[e.BUSINESS=6e3]="BUSINESS",e[e.CATALOGS=6022]="CATALOGS",e[e.EDUCATION=6017]="EDUCATION",e[e.ENTERTAINMENT=6016]="ENTERTAINMENT",e[e.FINANCE=6015]="FINANCE",e[e.FOOD_AND_DRINK=6023]="FOOD_AND_DRINK",e[e.GAMES=6014]="GAMES",e[e.GAMES_ACTION=7001]="GAMES_ACTION",e[e.GAMES_ADVENTURE=7002]="GAMES_ADVENTURE",e[e.GAMES_ARCADE=7003]="GAMES_ARCADE",e[e.GAMES_BOARD=7004]="GAMES_BOARD",e[e.GAMES_CARD=7005]="GAMES_CARD",e[e.GAMES_CASINO=7006]="GAMES_CASINO",e[e.GAMES_DICE=7007]="GAMES_DICE",e[e.GAMES_EDUCATIONAL=7008]="GAMES_EDUCATIONAL",e[e.GAMES_FAMILY=7009]="GAMES_FAMILY",e[e.GAMES_MUSIC=7011]="GAMES_MUSIC",e[e.GAMES_PUZZLE=7012]="GAMES_PUZZLE",e[e.GAMES_RACING=7013]="GAMES_RACING",e[e.GAMES_ROLE_PLAYING=7014]="GAMES_ROLE_PLAYING",e[e.GAMES_SIMULATION=7015]="GAMES_SIMULATION",e[e.GAMES_SPORTS=7016]="GAMES_SPORTS",e[e.GAMES_STRATEGY=7017]="GAMES_STRATEGY",e[e.GAMES_TRIVIA=7018]="GAMES_TRIVIA",e[e.GAMES_WORD=7019]="GAMES_WORD",e[e.HEALTH_AND_FITNESS=6013]="HEALTH_AND_FITNESS",e[e.LIFESTYLE=6012]="LIFESTYLE",e[e.MAGAZINES_AND_NEWSPAPERS=6021]="MAGAZINES_AND_NEWSPAPERS",e[e.MAGAZINES_ARTS=13007]="MAGAZINES_ARTS",e[e.MAGAZINES_AUTOMOTIVE=13006]="MAGAZINES_AUTOMOTIVE",e[e.MAGAZINES_WEDDINGS=13008]="MAGAZINES_WEDDINGS",e[e.MAGAZINES_BUSINESS=13009]="MAGAZINES_BUSINESS",e[e.MAGAZINES_CHILDREN=13010]="MAGAZINES_CHILDREN",e[e.MAGAZINES_COMPUTER=13011]="MAGAZINES_COMPUTER",e[e.MAGAZINES_FOOD=13012]="MAGAZINES_FOOD",e[e.MAGAZINES_CRAFTS=13013]="MAGAZINES_CRAFTS",e[e.MAGAZINES_ELECTRONICS=13014]="MAGAZINES_ELECTRONICS",e[e.MAGAZINES_ENTERTAINMENT=13015]="MAGAZINES_ENTERTAINMENT",e[e.MAGAZINES_FASHION=13002]="MAGAZINES_FASHION",e[e.MAGAZINES_HEALTH=13017]="MAGAZINES_HEALTH",e[e.MAGAZINES_HISTORY=13018]="MAGAZINES_HISTORY",e[e.MAGAZINES_HOME=13003]="MAGAZINES_HOME",e[e.MAGAZINES_LITERARY=13019]="MAGAZINES_LITERARY",e[e.MAGAZINES_MEN=13020]="MAGAZINES_MEN",e[e.MAGAZINES_MOVIES_AND_MUSIC=13021]="MAGAZINES_MOVIES_AND_MUSIC",e[e.MAGAZINES_POLITICS=13001]="MAGAZINES_POLITICS",e[e.MAGAZINES_OUTDOORS=13004]="MAGAZINES_OUTDOORS",e[e.MAGAZINES_FAMILY=13023]="MAGAZINES_FAMILY",e[e.MAGAZINES_PETS=13024]="MAGAZINES_PETS",e[e.MAGAZINES_PROFESSIONAL=13025]="MAGAZINES_PROFESSIONAL",e[e.MAGAZINES_REGIONAL=13026]="MAGAZINES_REGIONAL",e[e.MAGAZINES_SCIENCE=13027]="MAGAZINES_SCIENCE",e[e.MAGAZINES_SPORTS=13005]="MAGAZINES_SPORTS",e[e.MAGAZINES_TEENS=13028]="MAGAZINES_TEENS",e[e.MAGAZINES_TRAVEL=13029]="MAGAZINES_TRAVEL",e[e.MAGAZINES_WOMEN=13030]="MAGAZINES_WOMEN",e[e.MEDICAL=6020]="MEDICAL",e[e.MUSIC=6011]="MUSIC",e[e.NAVIGATION=6010]="NAVIGATION",e[e.NEWS=6009]="NEWS",e[e.PHOTO_AND_VIDEO=6008]="PHOTO_AND_VIDEO",e[e.PRODUCTIVITY=6007]="PRODUCTIVITY",e[e.REFERENCE=6006]="REFERENCE",e[e.SHOPPING=6024]="SHOPPING",e[e.SOCIAL_NETWORKING=6005]="SOCIAL_NETWORKING",e[e.SPORTS=6004]="SPORTS",e[e.TRAVEL=6003]="TRAVEL",e[e.UTILITIES=6002]="UTILITIES",e[e.WEATHER=6001]="WEATHER"}(s||(s={})),function(e){e.IPAD="iPadSoftware",e.MAC="macSoftware",e.ALL="software"}(o||(o={})),function(e){e.RECENT="mostRecent",e.HELPFUL="mostHelpful"}(A||(A={})),function(e){e[e.DZ=143563]="DZ",e[e.AO=143564]="AO",e[e.AI=143538]="AI",e[e.AR=143505]="AR",e[e.AM=143524]="AM",e[e.AU=143460]="AU",e[e.AT=143445]="AT",e[e.AZ=143568]="AZ",e[e.BH=143559]="BH",e[e.BB=143541]="BB",e[e.BY=143565]="BY",e[e.BE=143446]="BE",e[e.BZ=143555]="BZ",e[e.BM=143542]="BM",e[e.BO=143556]="BO",e[e.BW=143525]="BW",e[e.BR=143503]="BR",e[e.VG=143543]="VG",e[e.BN=143560]="BN",e[e.BG=143526]="BG",e[e.CA=143455]="CA",e[e.KY=143544]="KY",e[e.CL=143483]="CL",e[e.CN=143465]="CN",e[e.CO=143501]="CO",e[e.CR=143495]="CR",e[e.HR=143494]="HR",e[e.CY=143557]="CY",e[e.CZ=143489]="CZ",e[e.DK=143458]="DK",e[e.DM=143545]="DM",e[e.EC=143509]="EC",e[e.EG=143516]="EG",e[e.SV=143506]="SV",e[e.EE=143518]="EE",e[e.FI=143447]="FI",e[e.FR=143442]="FR",e[e.DE=143443]="DE",e[e.GB=143444]="GB",e[e.GH=143573]="GH",e[e.GR=143448]="GR",e[e.GD=143546]="GD",e[e.GT=143504]="GT",e[e.GY=143553]="GY",e[e.HN=143510]="HN",e[e.HK=143463]="HK",e[e.HU=143482]="HU",e[e.IS=143558]="IS",e[e.IN=143467]="IN",e[e.ID=143476]="ID",e[e.IE=143449]="IE",e[e.IL=143491]="IL",e[e.IT=143450]="IT",e[e.JM=143511]="JM",e[e.JP=143462]="JP",e[e.JO=143528]="JO",e[e.KE=143529]="KE",e[e.KR=143466]="KR",e[e.KW=143493]="KW",e[e.LV=143519]="LV",e[e.LB=143497]="LB",e[e.LT=143520]="LT",e[e.LU=143451]="LU",e[e.MO=143515]="MO",e[e.MK=143530]="MK",e[e.MG=143531]="MG",e[e.MY=143473]="MY",e[e.ML=143532]="ML",e[e.MT=143521]="MT",e[e.MU=143533]="MU",e[e.MX=143468]="MX",e[e.MS=143547]="MS",e[e.NP=143484]="NP",e[e.NL=143452]="NL",e[e.NZ=143461]="NZ",e[e.NI=143512]="NI",e[e.NE=143534]="NE",e[e.NG=143561]="NG",e[e.NO=143457]="NO",e[e.OM=143562]="OM",e[e.PK=143477]="PK",e[e.PA=143485]="PA",e[e.PY=143513]="PY",e[e.PE=143507]="PE",e[e.PH=143474]="PH",e[e.PL=143478]="PL",e[e.PT=143453]="PT",e[e.QA=143498]="QA",e[e.RO=143487]="RO",e[e.RU=143469]="RU",e[e.SA=143479]="SA",e[e.SN=143535]="SN",e[e.SG=143464]="SG",e[e.SK=143496]="SK",e[e.SI=143499]="SI",e[e.ZA=143472]="ZA",e[e.ES=143454]="ES",e[e.LK=143486]="LK",e[e.SR=143554]="SR",e[e.SE=143456]="SE",e[e.CH=143459]="CH",e[e.TW=143470]="TW",e[e.TZ=143572]="TZ",e[e.TH=143475]="TH",e[e.TN=143536]="TN",e[e.TR=143480]="TR",e[e.UG=143537]="UG",e[e.UA=143492]="UA",e[e.AE=143481]="AE",e[e.US=143441]="US",e[e.UY=143514]="UY",e[e.UZ=143566]="UZ",e[e.VE=143502]="VE",e[e.VN=143471]="VN",e[e.YE=143571]="YE"}(E||(E={}));class p extends Error{constructor(e){super(e),this.name="AppStoreClientError"}}class S extends p{constructor(e){super(e?`App with ID ${e} not found`:"App not found"),this.name="AppNotFoundError"}}class c extends p{constructor(e){super(`AppStore API error: ${e}`),this.name="AppStoreAPIError"}}class I extends p{constructor(e){super(`Invalid parameter: ${e}`),this.name="InvalidParameterError"}}class l extends p{constructor(e){super(`Network error: ${e}`),this.name="NetworkError"}}function u(e){return{id:e.id.attributes["im:id"],appId:e.id.attributes["im:bundleId"],title:e["im:name"]?.label,url:Array.isArray(e.link)?e.link[0]?.attributes.href:e.link?.attributes.href,description:e.summary?.label,icon:e["im:image"][2]?.label,genres:[e.category?.attributes?.label],genreIds:[e.category?.attributes["im:id"]],primaryGenre:e.category?.attributes?.label,primaryGenreId:e.category?.attributes["im:id"],contentRating:e["im:contentType"]?.attributes?.label,languages:[],size:"",requiredOsVersion:"",released:e["im:releaseDate"]?.attributes?.label,updated:e["im:releaseDate"]?.attributes?.label,releaseNotes:"",version:"",price:e["im:price"]?.attributes?.amount,currency:e["im:price"]?.attributes?.currency,free:"0.00"===e["im:price"]?.attributes?.amount,developerId:`${e["im:artist"].attributes.href.split("/id")[1].split("?")[0]}`,developer:e["im:artist"].label,developerUrl:e["im:artist"].attributes.href,developerWebsite:"",score:0,reviews:0,currentVersionScore:0,currentVersionReviews:0,screenshots:Array.isArray(e.link)?[e.link[1]?.attributes.href]:[],ipadScreenshots:[],appletvScreenshots:[],supportedDevices:[]}}function N(e){return{id:`${e.trackId}`,appId:`${e.bundleId}`,title:e.trackName,url:e.trackViewUrl,description:e.description,icon:e.artworkUrl512||e.artworkUrl100||e.artworkUrl60,genres:e.genres,genreIds:e.genreIds,primaryGenre:e.primaryGenreName,primaryGenreId:e.primaryGenreId,contentRating:e.contentAdvisoryRating,languages:e.languageCodesISO2A,size:e.fileSizeBytes,requiredOsVersion:e.minimumOsVersion,released:e.releaseDate,updated:e.currentVersionReleaseDate||e.releaseDate,releaseNotes:e.releaseNotes,version:e.version,price:e.price,currency:e.currency,free:0===e.price,developerId:`${e.artistId}`,developer:e.artistName,developerUrl:e.artistViewUrl,developerWebsite:e.sellerUrl,score:e.averageUserRating,reviews:e.userRatingCount,currentVersionScore:e.averageUserRatingForCurrentVersion,currentVersionReviews:e.userRatingCountForCurrentVersion,screenshots:e.screenshotUrls,ipadScreenshots:e.ipadScreenshotUrls,appletvScreenshots:e.appletvScreenshotUrls,supportedDevices:e.supportedDevices}}const d=async(e,r,i={},n)=>{const a={...i,method:i.method||"GET",url:e,headers:r};let s=t;n&&(s=(e=>{const r=[];let i=0;const n=()=>{if(r.length>0&&i<e){const e=r.shift();e&&(i++,e())}},a=t.create();return a.interceptors.request.use((t=>new Promise((a=>{r.push((()=>{a(t),setTimeout((()=>{i--,n()}),1e3/e)})),n()})))),a})(n));try{return(await s(a)).data}catch(e){if(t.isAxiosError(e)&&e.response){if(404===e.response.status)throw new S(e.response.data.id);if(e.response.status>=400)throw new c(`${e.response.statusText}`)}throw e}};async function M(e,t="id",r=E.US,i="en",n={},a){const s=i?`&lang=${i}`:"",o=`https://itunes.apple.com/lookup?${t}=${e.join(",")}&country=${G(r)}&entity=software${s}`;try{const e=(await d(o,{},n,a)).results.filter((e=>void 0===e.wrapperType||"software"===e.wrapperType));return e.map(N)}catch(e){throw e instanceof p?e:new l(e.message)}}function G(e){const t=Object.entries(E).find((([,t])=>t===e));return t?t[0].toLowerCase():""}async function O(e){if(!e.id)throw new I("id");const t=e.country||E.US,i=`https://itunes.apple.com/${G(t)}/customer-reviews/id${e.id}?displayable-kind=11`,n=await d(i,{"X-Apple-Store-Front":`${t},12`},e.requestOptions);if(0===n.length)throw new S(e.id);return function(e){const t=r.load(e),i=t(".rating-count").text().match(/\d+/),n=Array.isArray(i)?parseInt(i[0]):0,a=t(".vote .total").map(((e,r)=>parseInt(t(r).text()))).get().reduce(((e,t,r)=>({...e,[5-r]:t})),{});return{ratings:n,histogram:a}}(n)}async function _(e){if(!e.id&&!e.appId)throw new I("id or appId");const t=e.id?"id":"bundleId",r=e.id||e.appId,i=e.country||E.US,n=e.language||"en-us",a=e.requestOptions,s=e.throttle||1e3,o=await M([r],t,i,n,a,s);if(0===o.length)throw new S(r);const A=o[0];if(e.ratings){const e=await O({id:A.id.toString()});return{...A,...e}}return A}async function T(e,r={},i={}){return(await t({method:"GET",url:e,headers:r,...i})).data}const m=n(i);function R(e){var t;return((t=e.feed.entry)?Array.isArray(t)?t:[t]:[]).map((e=>({id:e.id.label,userName:e.author.name.label,userUrl:e.author.uri.label,version:e["im:version"].label,score:parseInt(e["im:rating"].label),title:e.title.label,text:e.content.label,url:e.link.attributes.href,updated:e.updated.label})))}var h=Object.freeze({__proto__:null,app:_,appsByDeveloper:async function(e){if(!e.devId)throw new I("devId");const t=await M([e.devId],"id",e.country,e.language,e.requestOptions,e.throttle?1e3:void 0);if(0===t.length)throw new S(e.devId);return t},list:async function(e){if(e.collection=e.collection||a.TOP_FREE_IOS,e.num=e.num||50,e.num>200)throw new I("num");if(!Object.values(a).includes(e.collection))throw new I("collection");const t=e.category?`/genre=${e.category}`:"",r=`http://ax.itunes.apple.com/WebObjects/MZStoreServices.woa/ws/RSS/${e.collection}/${t}/limit=${e.num}/json?s=${e.country||E.US}`,i=(await T(r,{},e.requestOptions)).feed.entry;if(e.fullDetail){const t=i.map((e=>e.id.attributes["im:id"]));return await M(t,"id",e.country,e.language,e.requestOptions,e.throttle)}return i.map(u)},privacy:async function(e){const t=e.country||E.US;if(!e.id)throw new I("id");const r=`https://apps.apple.com/${t}/app/id${e.id}`,i=await d(r,{},e.requestOptions),n=/token%22%3A%22([^%]+)%22%7D/g.exec(i);if(!n)throw new Error("Unable to extract token from the response");const a=n[1],s=`https://amp-api.apps.apple.com/v1/catalog/${G(t)}/apps/${e.id}?platform=web&fields=privacyDetails`,o=await d(s,{Origin:"https://apps.apple.com",Authorization:`Bearer ${a}`},e.requestOptions);if(!o.data||0===o.data.length)throw new S(e.id);return o.data[0].attributes.privacyDetails},ratings:O,reviews:async function(e){let t;if(function(e){if(!e.id&&!e.appId)throw new Error("Either id or appId is required");if(e.sort&&!Object.values(A).includes(e.sort))throw new Error("Invalid sort "+e.sort);if(e.page&&e.page<1)throw new Error("Page cannot be lower than 1");if(e.page&&e.page>10)throw new Error("Page cannot be greater than 10")}(e),e.id)t=e.id;else{if(!e.appId)throw new I("Either id or appId is required");t=(await _(e)).id.toString()}e.sort=e.sort||A.RECENT,e.page=e.page||1;const r=`https://itunes.apple.com/${G(e.country||E.US)}/rss/customerreviews/page=${e.page}/id=${t}/sortby=${e.sort}/json`,i=await d(r,{},e.requestOptions);if(void 0===i.feed.entry)throw new S(t);return R(i)},search:async function(e){const t=e.country||E.US;if(!e.term)throw new I("term");const r="https://search.itunes.apple.com/WebObjects/MZStore.woa/wa/search?clientApplication=Software&media=software&term="+encodeURIComponent(e.term),i=await T(r,{"X-Apple-Store-Front":`${t},24 t:native`,"Accept-Language":e.language||"en-us"},e.requestOptions),n=i.bubbles[0]&&i.bubbles[0].results||[],a=Math.min(((e.page||1)-1)*(e.num||50),n.length),s=Math.min(a+(e.num||50),n.length),o=n.slice(a,s).map((e=>e.id));return e.idsOnly?o:await M(o,"id",e.country,e.language,e.requestOptions,e.throttle)},similarApps:async function(e){let t;if(e.id)t=e.id;else{if(!e.appId)throw new I("Either id or appId is required");t=(await _(e)).id.toString()}const r=e.country||E.US,i=await d(`https://itunes.apple.com/us/app/app/id${t}`,{"X-Apple-Store-Front":`${r},32`},e.requestOptions);if(i.includes("itemNotAvailable"))throw new S(t);if(-1===i.indexOf("customersAlsoBoughtApps"))return[];const n=/customersAlsoBoughtApps":(.*?\])/g.exec(i);return n?M(JSON.parse(n[1]),"id",e.country,e.language,e.requestOptions,e.throttle):[]},suggestedTerms:async function(e){if(!e||!e.term)throw new I("term");const t=e.country||E.US,r="https://search.itunes.apple.com/WebObjects/MZSearchHints.woa/wa/hints?clientApplication=Software&term="+encodeURIComponent(e.term),i={"X-Apple-Store-Front":`${t},29`},n=await d(r,i,e.requestOptions);return((await m(n)).plist.dict[0].array[0].dict||[]).map((e=>({term:e.string[0]})))}});class w{constructor(e={}){this.options={country:E.US,language:"en-us",cacheMaxAge:3e5,cacheMaxSize:1e3,...e};for(const[e,t]of Object.entries(h))this[e]=this.memoizeMethod(t)}memoizeMethod(t){return e((e=>t({...this.options,...e})),{normalizer:e=>JSON.stringify(e[0]),maxAge:this.options.cacheMaxAge,max:this.options.cacheMaxSize,promise:!0})}}export{w as AppStoreClient,s as Category,a as Collection,E as Country,o as Device,A as Sort};
//# sourceMappingURL=index.esm.js.map
