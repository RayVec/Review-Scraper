"use strict";var e=require("memoizee"),t=require("axios"),r=require("cheerio"),o=require("xml2js"),i=require("util");function s(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var o=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,o.get?o:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var n=s(r);var a,A,p,E,S;exports.Collection=void 0,(a=exports.Collection||(exports.Collection={})).TOP_MAC="topmacapps",a.TOP_FREE_MAC="topfreemacapps",a.TOP_GROSSING_MAC="topgrossingmacapps",a.TOP_PAID_MAC="toppaidmacapps",a.NEW_IOS="newapplications",a.NEW_FREE_IOS="newfreeapplications",a.NEW_PAID_IOS="newpaidapplications",a.TOP_FREE_IOS="topfreeapplications",a.TOP_FREE_IPAD="topfreeipadapplications",a.TOP_GROSSING_IOS="topgrossingapplications",a.TOP_GROSSING_IPAD="topgrossingipadapplications",a.TOP_PAID_IOS="toppaidapplications",a.TOP_PAID_IPAD="toppaidipadapplications",exports.Category=void 0,(A=exports.Category||(exports.Category={}))[A.BOOKS=6018]="BOOKS",A[A.BUSINESS=6e3]="BUSINESS",A[A.CATALOGS=6022]="CATALOGS",A[A.EDUCATION=6017]="EDUCATION",A[A.ENTERTAINMENT=6016]="ENTERTAINMENT",A[A.FINANCE=6015]="FINANCE",A[A.FOOD_AND_DRINK=6023]="FOOD_AND_DRINK",A[A.GAMES=6014]="GAMES",A[A.GAMES_ACTION=7001]="GAMES_ACTION",A[A.GAMES_ADVENTURE=7002]="GAMES_ADVENTURE",A[A.GAMES_ARCADE=7003]="GAMES_ARCADE",A[A.GAMES_BOARD=7004]="GAMES_BOARD",A[A.GAMES_CARD=7005]="GAMES_CARD",A[A.GAMES_CASINO=7006]="GAMES_CASINO",A[A.GAMES_DICE=7007]="GAMES_DICE",A[A.GAMES_EDUCATIONAL=7008]="GAMES_EDUCATIONAL",A[A.GAMES_FAMILY=7009]="GAMES_FAMILY",A[A.GAMES_MUSIC=7011]="GAMES_MUSIC",A[A.GAMES_PUZZLE=7012]="GAMES_PUZZLE",A[A.GAMES_RACING=7013]="GAMES_RACING",A[A.GAMES_ROLE_PLAYING=7014]="GAMES_ROLE_PLAYING",A[A.GAMES_SIMULATION=7015]="GAMES_SIMULATION",A[A.GAMES_SPORTS=7016]="GAMES_SPORTS",A[A.GAMES_STRATEGY=7017]="GAMES_STRATEGY",A[A.GAMES_TRIVIA=7018]="GAMES_TRIVIA",A[A.GAMES_WORD=7019]="GAMES_WORD",A[A.HEALTH_AND_FITNESS=6013]="HEALTH_AND_FITNESS",A[A.LIFESTYLE=6012]="LIFESTYLE",A[A.MAGAZINES_AND_NEWSPAPERS=6021]="MAGAZINES_AND_NEWSPAPERS",A[A.MAGAZINES_ARTS=13007]="MAGAZINES_ARTS",A[A.MAGAZINES_AUTOMOTIVE=13006]="MAGAZINES_AUTOMOTIVE",A[A.MAGAZINES_WEDDINGS=13008]="MAGAZINES_WEDDINGS",A[A.MAGAZINES_BUSINESS=13009]="MAGAZINES_BUSINESS",A[A.MAGAZINES_CHILDREN=13010]="MAGAZINES_CHILDREN",A[A.MAGAZINES_COMPUTER=13011]="MAGAZINES_COMPUTER",A[A.MAGAZINES_FOOD=13012]="MAGAZINES_FOOD",A[A.MAGAZINES_CRAFTS=13013]="MAGAZINES_CRAFTS",A[A.MAGAZINES_ELECTRONICS=13014]="MAGAZINES_ELECTRONICS",A[A.MAGAZINES_ENTERTAINMENT=13015]="MAGAZINES_ENTERTAINMENT",A[A.MAGAZINES_FASHION=13002]="MAGAZINES_FASHION",A[A.MAGAZINES_HEALTH=13017]="MAGAZINES_HEALTH",A[A.MAGAZINES_HISTORY=13018]="MAGAZINES_HISTORY",A[A.MAGAZINES_HOME=13003]="MAGAZINES_HOME",A[A.MAGAZINES_LITERARY=13019]="MAGAZINES_LITERARY",A[A.MAGAZINES_MEN=13020]="MAGAZINES_MEN",A[A.MAGAZINES_MOVIES_AND_MUSIC=13021]="MAGAZINES_MOVIES_AND_MUSIC",A[A.MAGAZINES_POLITICS=13001]="MAGAZINES_POLITICS",A[A.MAGAZINES_OUTDOORS=13004]="MAGAZINES_OUTDOORS",A[A.MAGAZINES_FAMILY=13023]="MAGAZINES_FAMILY",A[A.MAGAZINES_PETS=13024]="MAGAZINES_PETS",A[A.MAGAZINES_PROFESSIONAL=13025]="MAGAZINES_PROFESSIONAL",A[A.MAGAZINES_REGIONAL=13026]="MAGAZINES_REGIONAL",A[A.MAGAZINES_SCIENCE=13027]="MAGAZINES_SCIENCE",A[A.MAGAZINES_SPORTS=13005]="MAGAZINES_SPORTS",A[A.MAGAZINES_TEENS=13028]="MAGAZINES_TEENS",A[A.MAGAZINES_TRAVEL=13029]="MAGAZINES_TRAVEL",A[A.MAGAZINES_WOMEN=13030]="MAGAZINES_WOMEN",A[A.MEDICAL=6020]="MEDICAL",A[A.MUSIC=6011]="MUSIC",A[A.NAVIGATION=6010]="NAVIGATION",A[A.NEWS=6009]="NEWS",A[A.PHOTO_AND_VIDEO=6008]="PHOTO_AND_VIDEO",A[A.PRODUCTIVITY=6007]="PRODUCTIVITY",A[A.REFERENCE=6006]="REFERENCE",A[A.SHOPPING=6024]="SHOPPING",A[A.SOCIAL_NETWORKING=6005]="SOCIAL_NETWORKING",A[A.SPORTS=6004]="SPORTS",A[A.TRAVEL=6003]="TRAVEL",A[A.UTILITIES=6002]="UTILITIES",A[A.WEATHER=6001]="WEATHER",exports.Device=void 0,(p=exports.Device||(exports.Device={})).IPAD="iPadSoftware",p.MAC="macSoftware",p.ALL="software",exports.Sort=void 0,(E=exports.Sort||(exports.Sort={})).RECENT="mostRecent",E.HELPFUL="mostHelpful",exports.Country=void 0,(S=exports.Country||(exports.Country={}))[S.DZ=143563]="DZ",S[S.AO=143564]="AO",S[S.AI=143538]="AI",S[S.AR=143505]="AR",S[S.AM=143524]="AM",S[S.AU=143460]="AU",S[S.AT=143445]="AT",S[S.AZ=143568]="AZ",S[S.BH=143559]="BH",S[S.BB=143541]="BB",S[S.BY=143565]="BY",S[S.BE=143446]="BE",S[S.BZ=143555]="BZ",S[S.BM=143542]="BM",S[S.BO=143556]="BO",S[S.BW=143525]="BW",S[S.BR=143503]="BR",S[S.VG=143543]="VG",S[S.BN=143560]="BN",S[S.BG=143526]="BG",S[S.CA=143455]="CA",S[S.KY=143544]="KY",S[S.CL=143483]="CL",S[S.CN=143465]="CN",S[S.CO=143501]="CO",S[S.CR=143495]="CR",S[S.HR=143494]="HR",S[S.CY=143557]="CY",S[S.CZ=143489]="CZ",S[S.DK=143458]="DK",S[S.DM=143545]="DM",S[S.EC=143509]="EC",S[S.EG=143516]="EG",S[S.SV=143506]="SV",S[S.EE=143518]="EE",S[S.FI=143447]="FI",S[S.FR=143442]="FR",S[S.DE=143443]="DE",S[S.GB=143444]="GB",S[S.GH=143573]="GH",S[S.GR=143448]="GR",S[S.GD=143546]="GD",S[S.GT=143504]="GT",S[S.GY=143553]="GY",S[S.HN=143510]="HN",S[S.HK=143463]="HK",S[S.HU=143482]="HU",S[S.IS=143558]="IS",S[S.IN=143467]="IN",S[S.ID=143476]="ID",S[S.IE=143449]="IE",S[S.IL=143491]="IL",S[S.IT=143450]="IT",S[S.JM=143511]="JM",S[S.JP=143462]="JP",S[S.JO=143528]="JO",S[S.KE=143529]="KE",S[S.KR=143466]="KR",S[S.KW=143493]="KW",S[S.LV=143519]="LV",S[S.LB=143497]="LB",S[S.LT=143520]="LT",S[S.LU=143451]="LU",S[S.MO=143515]="MO",S[S.MK=143530]="MK",S[S.MG=143531]="MG",S[S.MY=143473]="MY",S[S.ML=143532]="ML",S[S.MT=143521]="MT",S[S.MU=143533]="MU",S[S.MX=143468]="MX",S[S.MS=143547]="MS",S[S.NP=143484]="NP",S[S.NL=143452]="NL",S[S.NZ=143461]="NZ",S[S.NI=143512]="NI",S[S.NE=143534]="NE",S[S.NG=143561]="NG",S[S.NO=143457]="NO",S[S.OM=143562]="OM",S[S.PK=143477]="PK",S[S.PA=143485]="PA",S[S.PY=143513]="PY",S[S.PE=143507]="PE",S[S.PH=143474]="PH",S[S.PL=143478]="PL",S[S.PT=143453]="PT",S[S.QA=143498]="QA",S[S.RO=143487]="RO",S[S.RU=143469]="RU",S[S.SA=143479]="SA",S[S.SN=143535]="SN",S[S.SG=143464]="SG",S[S.SK=143496]="SK",S[S.SI=143499]="SI",S[S.ZA=143472]="ZA",S[S.ES=143454]="ES",S[S.LK=143486]="LK",S[S.SR=143554]="SR",S[S.SE=143456]="SE",S[S.CH=143459]="CH",S[S.TW=143470]="TW",S[S.TZ=143572]="TZ",S[S.TH=143475]="TH",S[S.TN=143536]="TN",S[S.TR=143480]="TR",S[S.UG=143537]="UG",S[S.UA=143492]="UA",S[S.AE=143481]="AE",S[S.US=143441]="US",S[S.UY=143514]="UY",S[S.UZ=143566]="UZ",S[S.VE=143502]="VE",S[S.VN=143471]="VN",S[S.YE=143571]="YE";class c extends Error{constructor(e){super(e),this.name="AppStoreClientError"}}class I extends c{constructor(e){super(e?`App with ID ${e} not found`:"App not found"),this.name="AppNotFoundError"}}class u extends c{constructor(e){super(`AppStore API error: ${e}`),this.name="AppStoreAPIError"}}class l extends c{constructor(e){super(`Invalid parameter: ${e}`),this.name="InvalidParameterError"}}class N extends c{constructor(e){super(`Network error: ${e}`),this.name="NetworkError"}}function d(e){return{id:e.id.attributes["im:id"],appId:e.id.attributes["im:bundleId"],title:e["im:name"]?.label,url:Array.isArray(e.link)?e.link[0]?.attributes.href:e.link?.attributes.href,description:e.summary?.label,icon:e["im:image"][2]?.label,genres:[e.category?.attributes?.label],genreIds:[e.category?.attributes["im:id"]],primaryGenre:e.category?.attributes?.label,primaryGenreId:e.category?.attributes["im:id"],contentRating:e["im:contentType"]?.attributes?.label,languages:[],size:"",requiredOsVersion:"",released:e["im:releaseDate"]?.attributes?.label,updated:e["im:releaseDate"]?.attributes?.label,releaseNotes:"",version:"",price:e["im:price"]?.attributes?.amount,currency:e["im:price"]?.attributes?.currency,free:"0.00"===e["im:price"]?.attributes?.amount,developerId:`${e["im:artist"].attributes.href.split("/id")[1].split("?")[0]}`,developer:e["im:artist"].label,developerUrl:e["im:artist"].attributes.href,developerWebsite:"",score:0,reviews:0,currentVersionScore:0,currentVersionReviews:0,screenshots:Array.isArray(e.link)?[e.link[1]?.attributes.href]:[],ipadScreenshots:[],appletvScreenshots:[],supportedDevices:[]}}function M(e){return{id:`${e.trackId}`,appId:`${e.bundleId}`,title:e.trackName,url:e.trackViewUrl,description:e.description,icon:e.artworkUrl512||e.artworkUrl100||e.artworkUrl60,genres:e.genres,genreIds:e.genreIds,primaryGenre:e.primaryGenreName,primaryGenreId:e.primaryGenreId,contentRating:e.contentAdvisoryRating,languages:e.languageCodesISO2A,size:e.fileSizeBytes,requiredOsVersion:e.minimumOsVersion,released:e.releaseDate,updated:e.currentVersionReleaseDate||e.releaseDate,releaseNotes:e.releaseNotes,version:e.version,price:e.price,currency:e.currency,free:0===e.price,developerId:`${e.artistId}`,developer:e.artistName,developerUrl:e.artistViewUrl,developerWebsite:e.sellerUrl,score:e.averageUserRating,reviews:e.userRatingCount,currentVersionScore:e.averageUserRatingForCurrentVersion,currentVersionReviews:e.userRatingCountForCurrentVersion,screenshots:e.screenshotUrls,ipadScreenshots:e.ipadScreenshotUrls,appletvScreenshots:e.appletvScreenshotUrls,supportedDevices:e.supportedDevices}}const O=async(e,r,o={},i)=>{const s={...o,method:o.method||"GET",url:e,headers:r};let n=t;i&&(n=(e=>{const r=[];let o=0;const i=()=>{if(r.length>0&&o<e){const e=r.shift();e&&(o++,e())}},s=t.create();return s.interceptors.request.use((t=>new Promise((s=>{r.push((()=>{s(t),setTimeout((()=>{o--,i()}),1e3/e)})),i()})))),s})(i));try{return(await n(s)).data}catch(e){if(t.isAxiosError(e)&&e.response){if(404===e.response.status)throw new I(e.response.data.id);if(e.response.status>=400)throw new u(`${e.response.statusText}`)}throw e}};async function G(e,t="id",r=exports.Country.US,o="en",i={},s){const n=o?`&lang=${o}`:"",a=`https://itunes.apple.com/lookup?${t}=${e.join(",")}&country=${_(r)}&entity=software${n}`;try{const e=(await O(a,{},i,s)).results.filter((e=>void 0===e.wrapperType||"software"===e.wrapperType));return e.map(M)}catch(e){throw e instanceof c?e:new N(e.message)}}function _(e){const t=Object.entries(exports.Country).find((([,t])=>t===e));return t?t[0].toLowerCase():""}async function T(e){if(!e.id)throw new l("id");const t=e.country||exports.Country.US,r=`https://itunes.apple.com/${_(t)}/customer-reviews/id${e.id}?displayable-kind=11`,o=await O(r,{"X-Apple-Store-Front":`${t},12`},e.requestOptions);if(0===o.length)throw new I(e.id);return function(e){const t=n.load(e),r=t(".rating-count").text().match(/\d+/),o=Array.isArray(r)?parseInt(r[0]):0,i=t(".vote .total").map(((e,r)=>parseInt(t(r).text()))).get().reduce(((e,t,r)=>({...e,[5-r]:t})),{});return{ratings:o,histogram:i}}(o)}async function m(e){if(!e.id&&!e.appId)throw new l("id or appId");const t=e.id?"id":"bundleId",r=e.id||e.appId,o=e.country||exports.Country.US,i=e.language||"en-us",s=e.requestOptions,n=e.throttle||1e3,a=await G([r],t,o,i,s,n);if(0===a.length)throw new I(r);const A=a[0];if(e.ratings){const e=await T({id:A.id.toString()});return{...A,...e}}return A}async function R(e,r={},o={}){return(await t({method:"GET",url:e,headers:r,...o})).data}const h=i.promisify(o.parseString);function w(e){var t;return((t=e.feed.entry)?Array.isArray(t)?t:[t]:[]).map((e=>({id:e.id.label,userName:e.author.name.label,userUrl:e.author.uri.label,version:e["im:version"].label,score:parseInt(e["im:rating"].label),title:e.title.label,text:e.content.label,url:e.link.attributes.href,updated:e.updated.label})))}var C=Object.freeze({__proto__:null,app:m,appsByDeveloper:async function(e){if(!e.devId)throw new l("devId");const t=await G([e.devId],"id",e.country,e.language,e.requestOptions,e.throttle?1e3:void 0);if(0===t.length)throw new I(e.devId);return t},list:async function(e){if(e.collection=e.collection||exports.Collection.TOP_FREE_IOS,e.num=e.num||50,e.num>200)throw new l("num");if(!Object.values(exports.Collection).includes(e.collection))throw new l("collection");const t=e.category?`/genre=${e.category}`:"",r=`http://ax.itunes.apple.com/WebObjects/MZStoreServices.woa/ws/RSS/${e.collection}/${t}/limit=${e.num}/json?s=${e.country||exports.Country.US}`,o=(await R(r,{},e.requestOptions)).feed.entry;if(e.fullDetail){const t=o.map((e=>e.id.attributes["im:id"]));return await G(t,"id",e.country,e.language,e.requestOptions,e.throttle)}return o.map(d)},privacy:async function(e){const t=e.country||exports.Country.US;if(!e.id)throw new l("id");const r=`https://apps.apple.com/${t}/app/id${e.id}`,o=await O(r,{},e.requestOptions),i=/token%22%3A%22([^%]+)%22%7D/g.exec(o);if(!i)throw new Error("Unable to extract token from the response");const s=i[1],n=`https://amp-api.apps.apple.com/v1/catalog/${_(t)}/apps/${e.id}?platform=web&fields=privacyDetails`,a=await O(n,{Origin:"https://apps.apple.com",Authorization:`Bearer ${s}`},e.requestOptions);if(!a.data||0===a.data.length)throw new I(e.id);return a.data[0].attributes.privacyDetails},ratings:T,reviews:async function(e){let t;if(function(e){if(!e.id&&!e.appId)throw new Error("Either id or appId is required");if(e.sort&&!Object.values(exports.Sort).includes(e.sort))throw new Error("Invalid sort "+e.sort);if(e.page&&e.page<1)throw new Error("Page cannot be lower than 1");if(e.page&&e.page>10)throw new Error("Page cannot be greater than 10")}(e),e.id)t=e.id;else{if(!e.appId)throw new l("Either id or appId is required");t=(await m(e)).id.toString()}e.sort=e.sort||exports.Sort.RECENT,e.page=e.page||1;const r=`https://itunes.apple.com/${_(e.country||exports.Country.US)}/rss/customerreviews/page=${e.page}/id=${t}/sortby=${e.sort}/json`,o=await O(r,{},e.requestOptions);if(void 0===o.feed.entry)throw new I(t);return w(o)},search:async function(e){const t=e.country||exports.Country.US;if(!e.term)throw new l("term");const r="https://search.itunes.apple.com/WebObjects/MZStore.woa/wa/search?clientApplication=Software&media=software&term="+encodeURIComponent(e.term),o=await R(r,{"X-Apple-Store-Front":`${t},24 t:native`,"Accept-Language":e.language||"en-us"},e.requestOptions),i=o.bubbles[0]&&o.bubbles[0].results||[],s=Math.min(((e.page||1)-1)*(e.num||50),i.length),n=Math.min(s+(e.num||50),i.length),a=i.slice(s,n).map((e=>e.id));return e.idsOnly?a:await G(a,"id",e.country,e.language,e.requestOptions,e.throttle)},similarApps:async function(e){let t;if(e.id)t=e.id;else{if(!e.appId)throw new l("Either id or appId is required");t=(await m(e)).id.toString()}const r=e.country||exports.Country.US,o=await O(`https://itunes.apple.com/us/app/app/id${t}`,{"X-Apple-Store-Front":`${r},32`},e.requestOptions);if(o.includes("itemNotAvailable"))throw new I(t);if(-1===o.indexOf("customersAlsoBoughtApps"))return[];const i=/customersAlsoBoughtApps":(.*?\])/g.exec(o);return i?G(JSON.parse(i[1]),"id",e.country,e.language,e.requestOptions,e.throttle):[]},suggestedTerms:async function(e){if(!e||!e.term)throw new l("term");const t=e.country||exports.Country.US,r="https://search.itunes.apple.com/WebObjects/MZSearchHints.woa/wa/hints?clientApplication=Software&term="+encodeURIComponent(e.term),o={"X-Apple-Store-Front":`${t},29`},i=await O(r,o,e.requestOptions);return((await h(i)).plist.dict[0].array[0].dict||[]).map((e=>({term:e.string[0]})))}});exports.AppStoreClient=class{constructor(e={}){this.options={country:exports.Country.US,language:"en-us",cacheMaxAge:3e5,cacheMaxSize:1e3,...e};for(const[e,t]of Object.entries(C))this[e]=this.memoizeMethod(t)}memoizeMethod(t){return e((e=>t({...this.options,...e})),{normalizer:e=>JSON.stringify(e[0]),maxAge:this.options.cacheMaxAge,max:this.options.cacheMaxSize,promise:!0})}};
//# sourceMappingURL=index.cjs.js.map
